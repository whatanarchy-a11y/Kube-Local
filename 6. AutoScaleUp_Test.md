# K3s + NGINX HPA 오토스케일 실습 정리 (2 → 4)

## 목표
- k3s 클러스터에서 `nginx` Deployment를 **2개 파드로 시작**
- **부하(Stress)** 를 주어 CPU 사용률을 올리고
- **HPA(HorizontalPodAutoscaler)** 로 파드를 **최대 4개까지 자동 스케일 업**
- (옵션) 부하 중지 후 스케일 다운 관찰

---

## 사전 조건 (필수)
### 1) Metrics Server 정상 동작 확인
HPA(CPU 기반)는 metrics-server가 필요합니다.

```bash
kubectl top nodes
kubectl top pods -A | head
```

예시(정상):
```
NAME   CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)
cp1    72m          7%       1243Mi          31%
w1     29m          2%       466Mi           23%
w2     40m          4%       700Mi           35%
```

---

## 1) nginx + Service + HPA 배포 (min=2, max=4)

아래 YAML을 적용하면 됩니다.

```bash
cat <<'EOF' | kubectl apply -f -
apiVersion: v1
kind: Namespace
metadata:
  name: demo-hpa
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: demo-hpa
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.27-alpine
        ports:
        - containerPort: 80
        # HPA는 requests를 기준으로 CPU Utilization(%) 계산
        resources:
          requests:
            cpu: "50m"
            memory: "64Mi"
          limits:
            cpu: "300m"
            memory: "128Mi"
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
  namespace: demo-hpa
spec:
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-hpa
  namespace: demo-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx
  minReplicas: 2
  maxReplicas: 4
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Pods
        value: 2
        periodSeconds: 15
      - type: Percent
        value: 100
        periodSeconds: 15
      selectPolicy: Max
EOF
```

확인:
```bash
kubectl -n demo-hpa get deploy,svc,hpa
kubectl -n demo-hpa get pods -o wide
```

---

## 2) HPA 관찰 (실시간)

```bash
kubectl -n demo-hpa get hpa -w
```

또는:
```bash
kubectl -n demo-hpa get deploy nginx -w
kubectl -n demo-hpa get pods -w
kubectl -n demo-hpa top pods
```

---

## 3) 부하 주기 (Fortio 사용)

### Fortio로 3분 동안 동시성 200 부하
```bash
kubectl -n demo-hpa run -it --rm fortio \
  --image=fortio/fortio --restart=Never -- \
  load -qps 0 -t 3m -c 200 http://nginx-svc/
```

- `-c 200` : 동시성(Concurrency) 200  
- `-t 3m` : 3분 동안 요청  
- `-qps 0` : QPS 제한 없이 “최대한” 요청

> 실행 시 아래 문구가 나오면 정상(컨테이너 세션 로그 안내):
> `All commands and output from this session will be recorded in container logs...`

Fortio 중간 로그 예시(정상 범주):
```
Closing dead socket ... err="EOF"
```
- 부하 중 연결이 끊긴 소켓 정리 로그로 흔히 발생 가능

![Fortio 부하 생성 로그 예시](image-11.png)

---

## 4) 결과 확인: 2 → 4 스케일 업 성공

HPA 관찰 결과 예시:
```bash
kubectl -n demo-hpa get hpa -w
```

출력 예시(성공):
```
NAME        REFERENCE          TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
nginx-hpa   Deployment/nginx   cpu: 255%/50%   2         4         4          13m
```

의미:
- `cpu: 255%/50%` → 평균 CPU 사용률이 목표(50%)를 크게 초과
- `REPLICAS 4` → HPA가 nginx 파드를 **최대치(4)** 까지 스케일 업 완료

파드/배치 확인:
```bash
kubectl -n demo-hpa get pods -o wide
kubectl -n demo-hpa top pods
```

![Fortio 부하 결과 요약 예시](image-12.png)

---

## 5) (옵션) 부하 중지 후 AutoScale DOWN 관찰

부하를 멈추면(3분 종료 또는 Ctrl+C) 스케일 다운을 확인할 수 있습니다.

```bash
kubectl -n demo-hpa get hpa -w
kubectl -n demo-hpa get deploy nginx -w
```

> 스케일 다운은 보통 스케일 업보다 **느리게** 반응할 수 있습니다(안정화/평균 메트릭 영향).

---

## 참고: Busybox로 대체 부하(가장 단순)

```bash
kubectl -n demo-hpa run -it --rm loadgen \
  --image=busybox:1.36 --restart=Never -- \
  sh -c 'i=0; while true; do wget -qO- http://nginx-svc/ >/dev/null; i=$((i+1)); [ $((i%500)) -eq 0 ] && echo "req=$i"; done'
```

CPU가 충분히 안 오르면 2~5개 정도 여러 터미널에서 동시에 실행.

---

## 결론
- nginx(2 replicas) 배포
- Fortio로 부하 발생
- HPA가 자동으로 nginx 파드를 2 → 4로 스케일 업 성공 ✅

```bash
ubuntu@cp1:~$ kubectl -n demo-hpa get hpa -w
NAME        REFERENCE          TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
nginx-hpa   Deployment/nginx   cpu: 255%/50%   2         4         4          13m
nginx-hpa   Deployment/nginx   cpu: 257%/50%   2         4         4          13m
nginx-hpa   Deployment/nginx   cpu: 317%/50%   2         4         4          13m
nginx-hpa   Deployment/nginx   cpu: 278%/50%   2         4         4          13m
nginx-hpa   Deployment/nginx   cpu: 97%/50%    2         4         4          13m
nginx-hpa   Deployment/nginx   cpu: 0%/50%     2         4         4          14m
```
### 중지 후 재실행 Pod 수가 2로 다운

```bash
ubuntu@cp1:~$ kubectl -n demo-hpa get hpa -w
NAME        REFERENCE          TARGETS       MINPODS   MAXPODS   REPLICAS   AGE
nginx-hpa   Deployment/nginx   cpu: 0%/50%   2         4         4          18m
nginx-hpa   Deployment/nginx   cpu: 0%/50%   2         4         2          19m
```
