# Kubernetes(k3s) 핵심 용어/기능 정리 (실습용 Glossary)

본 문서는 대화에서 다룬 Kubernetes(k3s) 핵심 기능을 **단어(개념)별로 상세 정리**한 자료입니다.  
실습 환경 예시: `cp1(컨트롤플레인)`, `w1`, `w2` / k3s / `containerd`

---

## 1. Cluster (클러스터)

### 의미
- Kubernetes의 **전체 시스템 단위**.
- 구성 요소:
  - **Control Plane**: API Server, Scheduler, Controller Manager, (etcd 또는 k3s 내장 저장소 등)
  - **Worker Node**: 실제 Pod가 실행되는 노드들
  - **애드온**: CoreDNS, Ingress(예: Traefik), Metrics Server 등

### 무엇을 “변경”한다는 뜻인가?
- 클러스터의 네트워크(CNI), 인증/인가, 버전 업그레이드, 스토리지 구성 등 **전반**에 영향.
- 영향 범위가 크기 때문에 운영에서는 절차(백업/점검/단계적 업그레이드)를 따름.

### 확인 명령
```bash
kubectl cluster-info
kubectl get nodes -o wide
```

---

## 2. Node (노드)

### 의미
- 클러스터에 참여하는 **물리/가상 머신**.
- kubelet + 컨테이너 런타임(containerd 등)이 Pod를 실행.

### 자주 하는 변경/운영 작업
- 라벨/태인트(taint) 변경 → 스케줄링에 영향
- cordon/drain → 유지보수/교체 시 안전하게 Pod 이동
- 노드 추가/제거 → 클러스터 용량 변화

### 확인 명령
```bash
kubectl get nodes -o wide
kubectl describe node <NODE>
```

---

## 3. Namespace (네임스페이스, NS)

### 의미
- 리소스를 논리적으로 분리하는 **구역(격리 단위)**.
- 팀/서비스별로 자원/권한/정책(NetworkPolicy, ResourceQuota 등)을 나누기 좋음.

### 중요한 제약
- 대부분의 리소스는 **다른 Namespace로 “이동”이 불가**(보통 재생성).
- Namespace 삭제 시 내부 리소스가 함께 삭제될 수 있어 주의.

### 확인/생성 명령
```bash
kubectl get ns
kubectl create ns <NAME>
```

---

## 4. Pod

### 의미
- Kubernetes의 **최소 실행 단위**.
- 1개 이상의 컨테이너가 같은 네트워크/스토리지 네임스페이스를 공유.

### 운영 관점
- Pod를 직접 수정하기보다 **Deployment/StatefulSet 같은 컨트롤러를 수정**해 롤링 업데이트가 정석.
- Pod는 많은 필드가 immutable이라 “수정”이라기보다 “재생성”되는 형태가 많음.

### 확인 명령
```bash
kubectl get pod -A -o wide
kubectl describe pod <POD> -n <NS>
kubectl logs <POD> -n <NS>
```

---

## 5. Service (서비스, SVC)

### 의미
- Pod 집합에 대한 **고정 접근점(가상 IP + DNS 이름)**.
- Pod는 IP가 바뀌어도 Service는 유지 → 안정적인 통신 제공

### 핵심 구성
- `selector`: 어떤 Pod 라벨을 백엔드로 삼을지
- `ports`: 어떤 포트를 열고 Pod의 targetPort로 보낼지
- 타입:
  - ClusterIP: 클러스터 내부 가상 IP
  - NodePort: 노드의 포트를 열어 외부에서 접근
  - LoadBalancer: 클라우드/환경에 따라 외부 LB 제공(또는 k3s ServiceLB 사용)

### 확인 명령
```bash
kubectl get svc -A -o wide
kubectl get ep  -A -o wide    # Endpoints(서비스 뒤 실제 Pod IP 목록)
```

---

## 6. Endpoint / Endpoints(서비스 뒤의 실제 대상)

### 의미
- Service가 트래픽을 보낼 실제 Pod IP/Port 목록.
- Service selector가 맞지 않거나 Pod가 준비되지 않으면 Endpoint가 비어 트래픽이 실패.

### 확인 명령
```bash
kubectl get ep <SVC> -n <NS> -o wide
kubectl describe svc <SVC> -n <NS>
```

---

## 7. CNI (Container Network Interface)

### 의미
- “Pod 네트워크를 실제로 구성하는 플러그인 표준/구현체”.
- Kubernetes는 “Pod 간 통신이 되어야 한다”는 요구만 하고, 실제 구현은 CNI가 담당.

### CNI가 하는 일
- Pod 생성 시:
  - Pod에 IP 할당
  - 네트워크 인터페이스 연결(veth 등)
  - 라우팅/오버레이 구성
- 플러그인에 따라:
  - NetworkPolicy 적용(트래픽 제어)
  - 관측/보안 기능 제공 등

### 장애 시 증상(대표)
- Pod가 IP를 못 받음
- 노드 간 Pod 통신 불가
- DNS/Service 통신이 꼬임

---

## 8. Flannel

### 의미
- 대표적인 CNI 구현체 중 하나.
- 노드 간 Pod 네트워크를 오버레이(VXLAN 등)로 구성해 **Pod ↔ Pod 통신**을 가능하게 함.

### k3s에서 “Pod/DaemonSet로 안 보일 수 있는 이유”
- k3s는 환경에 따라 Flannel이 “별도 DS로 보이는 형태”가 아니라,
  k3s 프로세스가 CNI 설정을 노드에 배치하여 동작시키는 경우가 있어
  `kube-system`에서 `kube-flannel-ds`가 안 보일 수 있음.

### 간접 확인(예)
- Pod IP가 `10.42.x.x`처럼 k3s 기본 Pod CIDR 대역인 경우가 많음
- Pod 내부에서 라우팅/인터페이스 확인:
```bash
kubectl -n <NS> exec -it <POD> -- ip addr
kubectl -n <NS> exec -it <POD> -- ip route
```

---

## 9. veth (Virtual Ethernet pair)

### 의미
- 리눅스의 “가상 이더넷 케이블”.
- **쌍(pair)** 으로 생성되며, 한쪽으로 들어간 트래픽이 다른쪽으로 나오는 구조.

### Kubernetes에서의 역할(개념)
- Pod 네임스페이스 안의 `eth0`는 veth 한쪽 끝.
- 노드(호스트) 네임스페이스에 veth 반대쪽 끝이 존재.
- CNI가 이를 브릿지/라우팅/오버레이에 연결해 통신을 성립시킴.

### kubectl로 확인 가능한 범위
- Pod 내부에서 `eth0` 및 라우팅 확인:
```bash
kubectl -n <NS> exec -it <POD> -- ip link
kubectl -n <NS> exec -it <POD> -- ip addr
```

---

## 10. Taint (테인트)

### 의미
- **노드에 붙이는 “거부/제한 규칙”**.
- “이 노드에는 특정 Pod만 올라오게 하겠다”를 강제.

### 형식
- `key=value:effect`

### effect 종류
- `NoSchedule`: toleration 없는 Pod는 스케줄링 불가(강제)
- `PreferNoSchedule`: 가능하면 피함(soft)
- `NoExecute`: toleration 없으면 기존 Pod도 퇴거(evict)

### 사용 예
- GPU 전용 노드
- 특정 서비스 전용 노드
- 컨트롤플레인 노드에 일반 워크로드 제한 등

### 명령
```bash
kubectl taint nodes <NODE> dedicated=lab:NoSchedule
kubectl taint nodes <NODE> dedicated=lab:NoSchedule-   # 제거
```

---

## 11. Toleration (톨러레이션)

### 의미
- Pod 쪽에서 “이 taint를 견딜 수 있다”고 선언하는 규칙.
- taint(노드) + toleration(Pod)이 맞아야 스케줄 가능.

### 예(개념)
- 노드: `dedicated=lab:NoSchedule`
- Pod: `tolerations: [{key: dedicated, value: lab, effect: NoSchedule}]`

---

## 12. Cordon

### 의미
- 노드를 **Unschedulable(새 Pod 배치 금지)** 로 만드는 것.
- 이미 떠 있는 Pod는 그대로 두고, **새로 생기는 Pod만** 다른 노드로 가게 함.

### 명령
```bash
kubectl cordon <NODE>
kubectl uncordon <NODE>
```

---

## 13. Drain

### 의미
- 노드를 유지보수/교체하기 위해 **노드 위의 Pod를 안전하게 비우는 절차**.
- 보통 drain 과정에서 cordon이 함께 적용됨.

### 동작(개념)
- 기존 Pod를 **evict(퇴거)** → 컨트롤러가 다른 노드에 재생성(Deployment 등)
- Node 오브젝트 자체는 삭제되지 않음

### 자주 막히는 이유: DaemonSet
- drain은 기본적으로 **DaemonSet-managed Pod는 삭제하지 않음**
- 그래서 아래 옵션을 자주 사용:
```bash
kubectl drain <NODE> --ignore-daemonsets --delete-emptydir-data
```

---

## 14. Delete

### 의미
- “리소스 자체를 삭제(없애기)”.
- drain과 다름:
  - **drain**: 노드는 남기고 Pod를 옮김(퇴거)
  - **delete**: 대상 리소스를 제거

### 예
```bash
kubectl delete pod <POD> -n <NS>
kubectl delete deploy <DEPLOY> -n <NS>
kubectl delete svc <SVC> -n <NS>
kubectl delete node <NODE>   # 클러스터에서 노드 오브젝트 제거 (주의)
```

---

## 15. DaemonSet

### 의미
- “**노드마다 1개씩 Pod를 반드시 실행**”하는 워크로드.
- 노드가 늘면 자동으로 해당 노드에 Pod 1개가 추가됨.

### 주 사용처
- 로그 수집 에이전트
- 모니터링 에이전트
- CNI/CSI 노드 플러그인
- k3s ServiceLB(klipper-lb) 계열

### 확인 명령
```bash
kubectl get ds -A
kubectl -n kube-system describe ds <DS_NAME>
```

---

## 16. k3s의 `svclb-traefik-*` (ServiceLB / klipper-lb)

### 의미
- k3s 환경에서 `LoadBalancer` 타입 Service를 지원하기 위해
  노드마다 떠서 트래픽을 프록시/포워딩하는 **DaemonSet Pod** 계열.
- 당신 환경의 에러 메시지:
  - `cannot delete DaemonSet-managed Pods ... kube-system/svclb-traefik-...`
  - drain이 DaemonSet Pod를 기본으로 삭제하지 못해 발생.

### 관련 확인
```bash
kubectl -n kube-system get ds
kubectl -n kube-system get pods -o wide | grep svclb
```

---

## 17. Provisioning (프로비저닝)

### 의미
- “필요한 자원을 **준비/생성/할당**하는 것”.
- drain의 반대 개념이 아님(대상이 다름).

### (A) 스토리지 프로비저닝(가장 흔함)
- PVC 생성 시 PV를 자동 생성/바인딩하는 **동적 프로비저닝**.
- 구성: StorageClass + (CSI 또는 프로비저너)

### (B) 노드(컴퓨트) 프로비저닝
- 노드를 자동으로 늘려 Pod 수용.
- Kubernetes 핵심만으로 자동 생성되기보다, Cluster Autoscaler/Karpenter 등 도구가 담당.

---

## 18. local-path-provisioner (k3s 기본 스토리지 프로비저너)

### 의미
- k3s에서 자주 쓰이는 “로컬 디스크 기반” 동적 스토리지 프로비저너.
- PVC 만들면 노드의 특정 경로에 PV를 만들어 붙여줌.

### 관련 ConfigMap
- `kube-system/local-path-config`: local-path-provisioner 설정

### 확인
```bash
kubectl get storageclass
kubectl -n kube-system get deploy local-path-provisioner
kubectl -n kube-system get cm local-path-config -o yaml
```

---

## 19. ConfigMap (CM) - kube-system에 보이는 것들의 의미

### `coredns`
- CoreDNS의 핵심 설정(Corefile)이 들어있음.
- 서비스 DNS(`*.svc.cluster.local`) 해석과 외부 DNS 포워딩 등을 담당.

### `cluster-dns`
- k3s에서 클러스터 DNS 관련 파라미터(도메인/서비스 IP 등)를 담는 경우가 많음(환경별 차이).

### `extension-apiserver-authentication`
- 확장 API 서버/애그리게이션/웹훅 등이 API Server 인증을 위해 참고하는 공용 설정.

### `kube-root-ca.crt`
- 클러스터 Root CA 인증서(네임스페이스별로도 자동 생성되는 경우 많음).

### `chart-content-traefik`, `chart-content-traefik-crd`
- k3s가 Traefik을 HelmChart 방식으로 관리할 때 남는 흔적(환경에 따라 DATA=0일 수 있음).

---

# 부록 A) “drain vs delete” 한눈에 비교

- **drain**
  - 노드 유지보수 목적
  - Pod를 evict하여 다른 노드로 이동(컨트롤러가 재생성)
  - 노드 오브젝트는 유지

- **delete**
  - 리소스를 제거
  - 대상에 따라 영향 범위가 큼(Pod/Deploy/SVC/Node 등)

---

# 부록 B) 실습 환경에서 실제로 나온 상황 정리

- 노드: `cp1`, `w1`, `w2`
- `kubectl drain w1` 실행 시:
  - `node/w1 cordoned` (cordon은 됨)
  - DaemonSet Pod `kube-system/svclb-traefik-...` 때문에 drain이 중단
- 해결:
```bash
kubectl drain w1 --ignore-daemonsets --delete-emptydir-data
# 실습 후 복구:
kubectl uncordon w1
```

---

# 부록 C) 실습 체크용 빠른 명령 모음

```bash
# 노드/파드 현황
kubectl get nodes -o wide
kubectl get pods -A -o wide

# 서비스/엔드포인트
kubectl get svc -A -o wide
kubectl get ep  -A -o wide

# DaemonSet 확인
kubectl get ds -A
kubectl -n kube-system get pods -o wide | grep svclb

# cordon / drain / uncordon
kubectl cordon <NODE>
kubectl drain <NODE> --ignore-daemonsets --delete-emptydir-data
kubectl uncordon <NODE>

# taint / untaint
kubectl taint nodes <NODE> dedicated=lab:NoSchedule
kubectl taint nodes <NODE> dedicated=lab:NoSchedule-
```

---

끝.
