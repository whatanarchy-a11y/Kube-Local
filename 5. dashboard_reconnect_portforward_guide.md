# Dashboard 재접속/재부팅 후 “안 보임” 해결 가이드 (port-forward/SSH 터널 정리)

> 목표: `https://192.168.56.10:8443/` 로 Dashboard가 안 열릴 때,
> **원인을 2가지로 딱 분리**하고(리슨 없음 vs 루프백 바인딩), **확실히 복구**합니다.

- 날짜: 2026-01-10

---

## 0) “안 보이는” 대표 원인 2가지

1) cp1에서 `kubectl port-forward`가 **실행 중이 아님**
2) 8443이 **127.0.0.1(루프백)에만 바인딩**되어 외부(Windows)에서 접근 불가

특히 SSH 터널(`ssh -L 8443:localhost:8443 ...`)은 cp1 기준으로 **127.0.0.1:8443**만 잡는 경우가 많아,
그 상태에서 `https://192.168.56.10:8443`로는 절대 접속이 안 됩니다.

![port-forward 연결 거부 예시](image-5.png)

---

## 1) cp1에서 “현재 8443 누가 잡고 있나” 확인

cp1에서:
```bash
sudo ss -lntp | grep ':8443' || echo "no listener on 8443"
```

### 케이스 A) 아무도 안 잡고 있음
```text
no listener on 8443
```
→ `kubectl port-forward`를 다시 띄워야 합니다 (섹션 2)

### 케이스 B) ssh가 잡고 있음
```text
LISTEN ... 127.0.0.1:8443 ... users:(("ssh",pid=...,fd=...))
```
→ SSH 터널이 로컬 포트를 점유 중 (섹션 3)

### 케이스 C) kubectl이 잡고 있지만 루프백만
```text
LISTEN ... 127.0.0.1:8443 ... users:(("kubectl",pid=...,fd=...))
```
→ `--address 0.0.0.0` 없이 실행된 상태 (섹션 2-2)

---

## 2) 외부(Windows)에서 보이게 port-forward 띄우기

### 2-1) 기존 port-forward가 남아 있으면 종료

위 `ss` 출력에서 `kubectl` PID를 확인했다면 종료:
```bash
sudo kill <PID>
```

(정리 확인)
```bash
sudo ss -lntp | grep ':8443' || echo "no listener on 8443"
```

### 2-2) 외부 바인딩으로 다시 실행 (중요)

```bash
kubectl -n kubernetes-dashboard port-forward   svc/kubernetes-dashboard-kong-proxy 8443:443   --address 0.0.0.0
```

이 터미널은 **켜 둔 채로 유지**해야 합니다(끊으면 포워딩도 종료).

정상 리슨 확인:
```bash
sudo ss -lntp | grep ':8443'
```

정상 형태:
- `0.0.0.0:8443` 또는 `192.168.56.10:8443` 에서 `kubectl`이 LISTEN

![외부 바인딩 포트포워딩 확인 예시](image-6.png)

---

## 3) SSH 터널(-L)이 8443을 점유 중이면

cp1에서 `ssh(pid=...)`가 8443을 잡고 있으면, 그 상태에서 `kubectl port-forward 8443:443`는 실패합니다.

해결은 2가지:

### 3-1) (추천) 포트 번호 변경

- SSH 터널과 port-forward 모두 9443 같은 다른 포트로 이동

Windows PowerShell:
```powershell
ssh -L 9443:localhost:9443 ubuntu@192.168.56.10
```

cp1(SSH 세션)에서:
```bash
kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy 9443:443
```

Windows 브라우저:
- `https://localhost:9443`

### 3-2) 점유 중인 ssh 프로세스 종료

cp1에서 PID가 확인된다면:
```bash
sudo kill <SSH_PID>
```

다시 확인:
```bash
sudo ss -lntp | grep ':8443' || echo "no listener on 8443"
```

> 단, 이 방식은 “현재 접속 세션/터널”을 끊을 수 있으니 보통 3-1이 편합니다.

---

## 4) Windows에서 브라우저 전에 포트 체크

PowerShell:
```powershell
Test-NetConnection 192.168.56.10 -Port 8443
```

- `TcpTestSucceeded : True` → 네트워크 OK, 이제 브라우저/인증서 경고 문제일 확률 높음
- `False` → cp1 리스닝/바인딩/방화벽 문제

---

## 5) 브라우저 인증서 경고는 정상

`https://192.168.56.10:8443` 접속 시 “안전하지 않음/개인정보 보호 오류”가 뜰 수 있습니다(자체 서명).
- **고급(Advanced) → 계속(Proceed)** 으로 들어가야 합니다.

---

## 6) UFW가 켜져 있으면 포트 허용(선택)

cp1에서:
```bash
sudo ufw status
```

`Status: active`면:
```bash
sudo ufw allow 8443/tcp
```

---

## 7) 토큰 다시 만들기

```bash
kubectl -n kubernetes-dashboard create token admin-user
```

---

## 8) 상태 확인

```bash
kubectl -n kubernetes-dashboard get pods,svc
```

---

## 참고(원본 단서)

원문에는 아래 사례가 포함되어 있습니다:
- `ssh`가 `127.0.0.1:8443` 점유 → `kubectl port-forward` 실패
- `kubectl`이 `127.0.0.1`로만 LISTEN → 외부 접속 불가 → `--address 0.0.0.0`로 해결
