# K3s 멀티노드 설치 가이드 (VirtualBox Host-Only 192.168.56.x, Ubuntu 22.04, Docker 없이)

> 목표: VirtualBox VM 3대(**cp1/w1/w2**)를 **Host-Only 네트워크(192.168.56.0/24)**로 묶고,
> **K3s 멀티노드 클러스터**를 설치/조인한 뒤 정상 동작까지 확인합니다.

- 날짜: 2026-01-10
- 전제: Host-Only가 구성되어 있고, VM들 간/호스트 간 **ping이 성공**해야 합니다.
  (Host-Only 구성은 별도 문서 “VirtualBox Host-Only 네트워크 가이드” 참고)

---

## 0) 목표 IP/역할

| 노드 | 역할 | Host-Only IP |
|---|---|---|
| cp1 | k3s server(control-plane) | `192.168.56.10` |
| w1 | k3s agent(worker) | `192.168.56.11` |
| w2 | k3s agent(worker) | `192.168.56.12` |

---

## 1) VirtualBox VM 네트워크 설정 (3대 모두)

각 VM → **Settings → Network**

- **Adapter 1**: `NAT`
- **Adapter 2**: `Host-only Adapter`
  - Name: `VirtualBox Host-Only Ethernet Adapter`(또는 vboxnet0 역할)
  - ✅ Cable connected 체크

> 이 설정이 되어야 **VM ↔ VM**, **Windows ↔ VM**이 `192.168.56.x`로 통신됩니다.

---

## 2) Ubuntu에서 Host-Only 고정 IP 설정 (netplan)

### 2-1) 인터페이스 이름 확인

각 VM에서:
```sh
ip -br a
```

보통:
- NAT: `enp0s3` (DHCP)
- Host-Only: `enp0s8` (정적)

> 아래 예시는 Host-Only가 `enp0s8`인 케이스 기준입니다. 다르면 이름만 바꾸세요.

### 2-2) cp1 (192.168.56.10)

```sh
sudo tee /etc/netplan/00-installer-config.yaml >/dev/null <<'EOF'
network:
  version: 2
  ethernets:
    enp0s3:
      dhcp4: true
    enp0s8:
      dhcp4: no
      addresses: [192.168.56.10/24]
EOF

sudo netplan apply
ip -br a
```

### 2-3) w1 / w2

위 파일에서 IP만 바꿉니다.

- w1: `192.168.56.11/24`
- w2: `192.168.56.12/24`

---

## 3) 통신 테스트 (여기서 성공해야 다음 진행)

### 3-1) Windows → cp1

PowerShell:
```powershell
ping 192.168.56.10
```

### 3-2) cp1 → Windows(Host-Only)

cp1에서:
```sh
ping -c 1 192.168.56.1
```

✅ 둘 다 성공하면 네트워크 준비 완료.

---

## 4) 호스트명(Hostname) 유니크 설정 (각 VM에서 1회)

```sh
sudo hostnamectl set-hostname cp1   # cp1에서
sudo hostnamectl set-hostname w1    # w1에서
sudo hostnamectl set-hostname w2    # w2에서
```

(선택) 바로 반영 확인:
```sh
hostname
```

---

## 5) K3s 설치

### 5-1) cp1: k3s server 설치

cp1에서:
```sh
sudo apt update && sudo apt install -y curl

curl -sfL https://get.k3s.io |   K3S_KUBECONFIG_MODE="644" sh -s -   --node-ip 192.168.56.10   --flannel-iface enp0s8
```

설치/상태 확인:
```sh
sudo systemctl status k3s --no-pager -l
kubectl get nodes -o wide
```

### 5-2) cp1: 조인 토큰 확인

```sh
sudo cat /var/lib/rancher/k3s/server/node-token
```

> 이 토큰을 w1/w2 조인 시 `K3S_TOKEN=`에 그대로 넣습니다.

---

## 6) w1/w2: k3s agent 조인

> ⚠️ 조인은 **WSL이 아니라 각 VM 콘솔/SSH**에서 실행하는 것을 권장합니다.
> (WSL ↔ Host-Only 직접 통신이 꼬이는 케이스가 많음)

### 6-1) w1 조인

```sh
sudo apt update && sudo apt install -y curl

curl -sfL https://get.k3s.io |   K3S_URL="https://192.168.56.10:6443"   K3S_TOKEN="(cp1에서 복사한 토큰)" sh -s -   --node-ip 192.168.56.11   --flannel-iface enp0s8
```

### 6-2) w2 조인

```sh
sudo apt update && sudo apt install -y curl

curl -sfL https://get.k3s.io |   K3S_URL="https://192.168.56.10:6443"   K3S_TOKEN="(cp1에서 복사한 토큰)" sh -s -   --node-ip 192.168.56.12   --flannel-iface enp0s8
```

---

## 7) 최종 확인 (cp1)

```sh
kubectl get nodes -o wide
kubectl get pods -A
```

정상 예시(형태):
```text
NAME  STATUS  ROLES                 AGE  VERSION
cp1   Ready   control-plane,master  ...
w1    Ready   <none>                ...
w2    Ready   <none>                ...
```

---

## 8) (문제 해결) 조인/통신이 꼬일 때 체크 포인트

### 8-1) cp1 API(6443) 접근 테스트

w1/w2에서:
```sh
curl -k https://192.168.56.10:6443/ping
```
(응답이 없더라도 “연결 자체”가 되는지 판단용)

### 8-2) node-ip / flannel-iface 실수

- `--node-ip`가 Host-Only IP와 일치해야 함
- `--flannel-iface`가 Host-Only 인터페이스와 일치해야 함 (`enp0s8` 등)

### 8-3) 방화벽(UFW)

UFW가 켜져 있으면 내부 통신이 막힐 수 있습니다.
```sh
sudo ufw status
```

---

## 부록) WSL에서 설치 로그가 섞였던 경우(주의)

WSL에서 `ip -br a`가 `172.x` 대역이고 `flannel.1`, `cni0`가 보였다면,
그 환경은 **VM Host-Only(192.168.56.x)** 멀티노드 조인과는 네트워크 모델이 달라서 막힐 가능성이 큽니다.

✅ 권장: **VM 내부에서만** server/agent 설치를 완료하고,
WSL은 추후 `kubectl` 관리용(원격 kubeconfig)으로만 사용합니다.

---

## 참고(원본 발췌/로그 단서)

원문에는 w1 조인 커맨드/토큰 예시, WSL 환경의 `ip -br a` 출력(172.x), iptables legacy 설정 관련 메모가 포함되어 있습니다.
필요 시, 당신 환경(인터페이스명/방화벽/iptables) 기준으로 “완전 복붙” 최종 커맨드를 다시 커스터마이징하세요.
