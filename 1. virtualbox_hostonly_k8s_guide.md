# VirtualBox 설치 & Host-Only 네트워크(vboxnet0) 구성 가이드 (Windows + Ubuntu, K8s 멀티노드 준비)

> 목표: Windows 호스트에서 VirtualBox로 **Kubernetes 멀티노드 VM 3대(cp1/w1/w2)**를 구성하기 위해,  
> **Host-Only 네트워크(일반적으로 vboxnet0 역할)**를 만들고, **정적 IP(192.168.56.10/11/12)**로 통신되게 설정합니다.

---

## 1) VirtualBox 다운로드/설치

- 다운로드: VirtualBox 공식 페이지  
  - https://www.virtualbox.org/wiki/Downloads

설치 중 **네트워크 드라이버/어댑터 설치 안내**가 뜨면 반드시 **허용(Install)** 하세요.  
(Host-Only가 안 생기는 가장 흔한 이유가 네트워크 구성요소/드라이버 설치 실패입니다.)

설치 후 필요 시 재부팅합니다.

---

## 2) Host-Only 네트워크(vboxnet0 역할) 만들기 (GUI)

VirtualBox 버전에 따라 메뉴 위치가 다를 수 있습니다. 아래 중 가능한 경로로 들어가세요.

### 경로 A: Network Manager/Host Network Manager

- VirtualBox 실행 → **File → Tools → Network Manager**  
  또는  
- VirtualBox 실행 → **File → Host Network Manager**

> 여기서 **Host-only Networks(호스트 전용 네트워크)** 탭에서 **Create(생성)** 를 누릅니다.

### 경로 B: Preferences(환경 설정)에서 생성

- VirtualBox 메인 화면 → **환경 설정(Preferences)** → **Network(네트워크)**  
- 탭에서 **Host-only Networks / Host Network Manager** 를 찾아 **추가(+) / Create** 로 생성

### 권장 설정

- **IPv4 Address**: `192.168.56.1`  
- **IPv4 Mask**: `255.255.255.0`  
- **DHCP Server**: `OFF(끔)` (VM에서 정적 IP를 쓸 예정이라 꺼두는 것을 권장)

생성되면 이름이 `vboxnet0`로 보이거나, Windows 쪽에 **VirtualBox Host-Only Ethernet Adapter**가 잡히는 형태로 나타납니다.

---

## 3) (대체 루트) VBoxManage로 Host-Only 생성/설정 (GUI 없이 가능)

GUI에서 메뉴가 안 보이거나 꼬인 경우, PowerShell에서 VirtualBox CLI로 확인/생성할 수 있습니다.

### 3-1) Host-Only 목록 확인

```powershell
& "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" list hostonlyifs
```

정상 예시:
```text
Name:            VirtualBox Host-Only Ethernet Adapter
DHCP:            Disabled
IPAddress:       192.168.56.1
NetworkMask:     255.255.255.0
Status:          Up
```

### 3-2) Host-Only 생성

```powershell
& "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" hostonlyif create
```

### 3-3) IP 설정

어댑터 이름은 `list hostonlyifs`에서 나온 **Name**을 그대로 사용합니다.

```powershell
& "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" hostonlyif ipconfig "VirtualBox Host-Only Ethernet Adapter" --ip 192.168.56.1 --netmask 255.255.255.0
```

---

## 4) Windows에서 Host-Only 어댑터 확인 (ipconfig가 안 잡히는 경우 포함)

`ipconfig | findstr "VirtualBox"`는 **어댑터 이름에 VirtualBox가 포함될 때만** 잡힐 수 있어요.  
Windows에선 이름이 그냥 **“이더넷”**으로 잡히고, 설명(InterfaceDescription)에만 VirtualBox가 들어가는 경우도 흔합니다.

### 4-1) 어댑터 존재 여부 확인(확실)

```powershell
Get-NetAdapter -IncludeHidden |
  Sort-Object Name |
  Format-Table -Auto Name, Status, InterfaceDescription
```

예시:
```text
Name    Status  InterfaceDescription
----    ------  --------------------
이더넷  Up      VirtualBox Host-Only Ethernet Adapter
```

### 4-2) Host-Only IPv4 주소 확인

(예: 인터페이스 별칭이 "이더넷"인 경우)

```powershell
Get-NetIPAddress -InterfaceAlias "이더넷" -AddressFamily IPv4
```

정상 예시:
```text
IPAddress      : 192.168.56.1
PrefixLength   : 24
PrefixOrigin   : Manual
```

필요하면(비어 있거나 다른 값이면) 강제 설정:
```powershell
New-NetIPAddress -InterfaceAlias "이더넷" -IPAddress 192.168.56.1 -PrefixLength 24
```

### 4-3) GUI에서 어댑터 활성화 확인

- 실행(Win+R): `ncpa.cpl`  
- “VirtualBox Host-Only …”가 보이면 **사용(Enable)** 상태인지 확인  
- 어댑터 속성에서 **Internet Protocol Version 4 (TCP/IPv4)** 체크 여부 확인

---

## 5) Host-Only 네트워크가 계속 안 보일 때(Repair/재설치)

- Expert 모드에도 네트워크 항목이 전혀 안 보이거나
- Host-Only 드라이버가 Windows에 안 잡히는 경우

✅ 가장 빠른 해결은 **VirtualBox 설치 파일 재실행 → Repair(복구)** 입니다.

1) 설치 파일(.exe) 다시 실행 → **Repair(복구)** 선택  
2) 드라이버 설치 경고가 뜨면 반드시 **Install/허용**  
3) 필요 시 재부팅  
4) 다시 `Get-NetAdapter` / `VBoxManage list hostonlyifs`로 확인

그래도 안 되면:
- 완전 제거 → 재부팅 → 최신 버전 재설치
- 회사 PC 보안/백신이 드라이버 설치를 막는지 점검

---

## 6) VM 3대(cp1/w1/w2)에 Host-Only 붙이기 (네트워크 어댑터 설정)

각 VM 설정 → **Network(네트워크)**

- **Adapter 1**: `NAT`
- **Adapter 2**: `Host-only Adapter`
  - Name: `VirtualBox Host-Only Ethernet Adapter` (또는 vboxnet0에 해당하는 항목)
  - ✅ **Cable connected** 체크

---

## 7) Ubuntu VM에서 정적 IP(192.168.56.10/11/12) 설정 (netplan)

VM에서 인터페이스 이름부터 확인합니다.

```sh
ip -br a
```

보통:
- NAT: `enp0s3` (DHCP)
- Host-Only: `enp0s8` (정적)

### cp1 (192.168.56.10)

```sh
sudo tee /etc/netplan/00-installer-config.yaml >/dev/null <<'EOF'
network:
  version: 2
  ethernets:
    enp0s3:
      dhcp4: true
    enp0s8:
      dhcp4: no
      addresses: [192.168.56.10/24]
EOF

sudo netplan apply
ip -br a
```

### w1 (192.168.56.11), w2 (192.168.56.12)

위 파일에서 `192.168.56.10`만 각각 `192.168.56.11`, `192.168.56.12`로 바꾸면 됩니다.

---

---
# VirtualBox에서 netplan YAML을 고정(변경 없이 유지)하는 방법

VirtualBox에서 **Ubuntu netplan YAML을 “고정(변경 없이 유지)”**하려면, 핵심은 이 2가지를 막는 겁니다.

1) **부팅/재부팅 때 netplan 파일이 다시 생성/덮어쓰기 되는 것**  
2) **클라우드-init / NetworkManager / systemd-networkd가 설정을 다시 바꾸는 것**

아래는 “가장 흔한 케이스” 기준으로, **변경 없이 고정**하는 실전 방법들입니다.

---

## 1) cloud-init이 netplan을 덮어쓰는 경우 (가장 흔함)

Ubuntu VM 이미지는 보통 cloud-init이 네트워크 설정을 관리하면서 `/etc/netplan/50-cloud-init.yaml` 같은 파일을 생성/갱신합니다.  
이때는 **cloud-init 네트워크 기능을 꺼야** netplan이 고정됩니다.

### A. cloud-init 네트워크 비활성화

```sh
sudo bash -lc 'cat >/etc/cloud/cloud.cfg.d/99-disable-network-config.cfg <<EOF
network: {config: disabled}
EOF'
```

### B. 기존 cloud-init netplan 파일은 내 설정으로 “대체”

- 권장: cloud-init 파일을 쓰지 말고, **내 파일**을 새로 만듭니다 (예: `01-netcfg.yaml`).
- 그리고 cloud-init이 만든 파일은 제거(또는 무시)합니다.

```sh
sudo rm -f /etc/netplan/50-cloud-init.yaml
```

### C. netplan 적용

```sh
sudo netplan generate
sudo netplan apply
```

### D. (선택) cloud-init 캐시까지 정리

이미 생성된 설정이 남아 계속 영향을 주면:

```sh
sudo cloud-init clean --logs
```

---

## 2) netplan YAML을 “절대 덮어쓰지 못하게” 파일 자체를 잠그기

정말 “고정”이 목적이면, 파일에 immutable(변경 불가) 속성을 걸면 강력합니다.

예: `/etc/netplan/01-netcfg.yaml`을 고정

```sh
sudo chattr +i /etc/netplan/01-netcfg.yaml
```

> 나중에 수정하려면 반드시:

```sh
sudo chattr -i /etc/netplan/01-netcfg.yaml
```

---

## 3) NetworkManager vs systemd-networkd 충돌 방지

Ubuntu Desktop은 NetworkManager가 기본인 경우가 많고, Server는 systemd-networkd가 기본인 경우가 많습니다.  
netplan의 `renderer`가 실제 환경과 맞아야 “안 바뀝니다”.

### Ubuntu Server(보통)

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s3:
      dhcp4: no
      addresses: [192.168.56.10/24]
      gateway4: 192.168.56.1
      nameservers:
        addresses: [8.8.8.8,1.1.1.1]
```

### Ubuntu Desktop(보통)

`renderer: NetworkManager`로 맞추는 게 안정적입니다.

```yaml
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    enp0s3:
      dhcp4: no
      addresses: [192.168.56.10/24]
```

적용:

```sh
sudo netplan apply
```

---

## 4) VirtualBox 쪽 “MAC 주소 고정”도 같이 해야 IP가 흔들리지 않음

netplan을 고정해도, VirtualBox에서 어댑터 MAC이 바뀌면 인터페이스 이름/매칭이 틀어질 수 있습니다.

- VirtualBox → VM 설정 → 네트워크 → 어댑터 → **MAC 주소 고정(수정하지 않기)**
- 가능하면 netplan에서 `match:`로 MAC을 묶어두면 더 안전합니다.

예:

```yaml
ethernets:
  lan0:
    match:
      macaddress: "08:00:27:12:34:56"
    set-name: lan0
    dhcp4: no
    addresses: [192.168.56.10/24]
```

---

## 가장 추천 조합 (진짜 안 바뀌게)

1) cloud-init 네트워크 끄기  
2) `/etc/netplan/01-netcfg.yaml`로 내 설정 관리  
3) 필요 시 `chattr +i`로 파일 잠금  
4) VirtualBox MAC 고정 + netplan match(macaddress) 사용

---

원하는 방향이 **“VM 복제/재부팅/업데이트해도 절대 유지”**인지, 아니면 **“VirtualBox Host-Only(192.168.56.x)에서만 안정적으로 유지”**인지에 따라 YAML 예시가 조금 달라집니다.  
지금 VM이 **Ubuntu Desktop**인지 **Server**인지(= NetworkManager인지 networkd인지)만 알려주면, 당신 환경에 딱 맞는 고정용 netplan 파일을 바로 완성본으로 써줄게요.

---


## 8) 통신 테스트(반드시 성공해야 다음 단계가 쉬움)

### Windows → cp1

```powershell
ping 192.168.56.10
```

### cp1 → Windows(Host-Only)

```sh
ping -c 1 192.168.56.1
```

✅ 여기까지 되면, 클러스터 구성 시 워커 조인 URL도 아래처럼 명확해집니다.

- 예: `https://192.168.56.10:6443`

---

## 9) 다음 단계(예고): K3s 멀티노드 조인 흐름

1) cp1에 k3s server 설치  
2) cp1에서 token 확인  
3) w1/w2에서 join  
4) `kubectl get nodes`로 3대 노드 확인

원하시면 cp1/w1/w2 구성(네트워크/OS 버전)에 맞춰 **k3s 설치/조인 명령을 그대로 복붙 가능한 형태로** 이어서 정리해드릴게요.
