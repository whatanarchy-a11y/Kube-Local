# K3s: Ingress + Metrics Server + Kubernetes Dashboard 구성 가이드

> 목표: K3s 멀티노드(또는 단일노드) 환경에서
> 1) **Ingress(라우팅)**, 2) **Metrics Server(top)**, 3) **Kubernetes Dashboard(웹 UI)**를 구성하고 접속합니다.

- 날짜: 2026-01-10
- 환경 전제: K3s, 기본 Traefik(대개 내장/Helm) 사용

---

## 0) 현재 상태 확인 (cp1)

```bash
kubectl get nodes -o wide
kubectl -n kube-system get deploy,svc | egrep "traefik|metrics" || true
kubectl -n kube-system get svc traefik -o wide
```

Traefik 서비스의 노출 방식(포트/EXTERNAL-IP)을 먼저 확인합니다.

---

## 1) Ingress 실습 (Traefik 기본 사용)

### 1-1) 테스트 앱(whoami) 배포

```bash
kubectl create deploy whoami --image=traefik/whoami
kubectl expose deploy whoami --port 80
kubectl get pod -o wide
kubectl get svc whoami
```

### 1-2) Ingress 생성 (host 기반 라우팅)

`ing-whoami.yaml`:
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: whoami-ing
spec:
  rules:
  - host: whoami.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: whoami
            port:
              number: 80
```

적용:
```bash
kubectl apply -f ing-whoami.yaml
kubectl get ingress
```

### 1-3) Windows hosts 파일에 도메인 매핑

Windows(관리자 권한)에서 파일 편집:
- `C:\Windows\System32\drivers\etc\hosts`

맨 아래 추가:
```text
192.168.56.10  whoami.local
```

브라우저:
- `http://whoami.local/`

> 안 열리면 우선 Traefik 서비스가 80으로 노출되는지, 포트 충돌(호스트 80 사용 중) 여부를 확인하세요.

---

## 2) Metrics Server 확인 & 사용

### 2-1) top 명령 (metrics-server 필요)

```bash
kubectl top nodes
kubectl top pods -A | head
```

### 2-2) metrics not available 대응

metrics-server 배포/로그 확인:
```bash
kubectl -n kube-system get deploy metrics-server
kubectl -n kube-system logs deploy/metrics-server --tail=50
```

(최후수단) upstream metrics-server 설치:
```bash
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```

> K3s 패키지 매니페스트는 재기동 시 덮어씌워질 수 있으니, “패키지 disable + 별도 설치” 전략이 필요할 수 있습니다.

---

## 3) Kubernetes Dashboard 설치 (Helm 표준)

### 3-1) Helm 설치 (cp1)

```bash
curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
helm version
```

### 3-2) Dashboard 설치

```bash
helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
helm repo update

helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard   --create-namespace --namespace kubernetes-dashboard
```

---

## 4) Helm이 “localhost:8080 접속” 하며 실패할 때(중요)

에러 형태:
```text
Get "http://localhost:8080/version": connect: connection refused
```

의미: Helm이 **kubeconfig를 못 찾아** 기본값 localhost:8080으로 접속한 것.

해결(즉시 적용):
```bash
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
helm ls -A
```

영구 적용(추천):
```bash
echo 'export KUBECONFIG=/etc/rancher/k3s/k3s.yaml' >> ~/.bashrc
source ~/.bashrc
```

권한 문제 시(읽기 권한이 없을 때) 홈으로 복사:
```bash
mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $USER:$USER ~/.kube/config
chmod 600 ~/.kube/config
unset KUBECONFIG
kubectl get nodes
```

---

## 5) Dashboard 접속(Port-forward)

### 옵션 A) cp1에서 외부 접근 가능하게 직접 바인딩(학습용)

```bash
kubectl -n kubernetes-dashboard port-forward   svc/kubernetes-dashboard-kong-proxy 8443:443   --address 0.0.0.0
```

Windows 브라우저:
- `https://192.168.56.10:8443`

> 브라우저 인증서 경고는 “고급 → 계속”으로 진행(자체 서명 인증서).

![Kubernetes Dashboard 접속 화면 예시](image-10.png)

### 옵션 B) SSH 터널(추천: 외부로 0.0.0.0 열지 않음)

Windows PowerShell:
```powershell
ssh -L 8443:localhost:8443 ubuntu@192.168.56.10
```

cp1(SSH 접속 세션)에서:
```bash
kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy 8443:443
```

Windows 브라우저:
- `https://localhost:8443`

---

## 6) “address already in use” 포트 충돌 해결

에러:
```text
bind: address already in use
```

의미: 이미 다른 프로세스가 8443을 점유 중(SSH -L, 기존 port-forward 등)

해결 2가지:

### 6-1) 포트 바꾸기(가장 빠름)

cp1:
```bash
kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy 9443:443
```

(SSH 터널도 포트를 맞춰야 함)
```powershell
ssh -L 9443:localhost:9443 ubuntu@192.168.56.10
```

브라우저:
- `https://localhost:9443` 또는 `https://192.168.56.10:9443`

### 6-2) 누가 점유 중인지 확인 후 종료

cp1:
```bash
sudo ss -lntp | grep ':8443' || echo "no listener on 8443"
```

PID 확인 후:
```bash
sudo kill <PID>
# 안 죽으면
sudo kill -9 <PID>
```

---

## 7) 로그인 토큰 생성 (학습용 관리자)

> ⚠️ 아래는 학습 편의용으로 **관리자 권한**을 줍니다. 운영 환경에서는 최소 권한으로 구성하세요.

`dash-admin.yaml`:
```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
```

적용 + 토큰:
```bash
kubectl apply -f dash-admin.yaml
kubectl -n kubernetes-dashboard create token admin-user
```

![Dashboard 관리자 토큰 생성 예시](image-4.png)

---

## 8) 상태 확인

```bash
kubectl -n kubernetes-dashboard get pods,svc
```

정상이라면 Pod들이 `Running`이고, 서비스에 `kubernetes-dashboard-kong-proxy`가 보입니다.

---

## 참고(원본 단서)

원문에는 Helm 설치/에러 원인(쿠버 설정 없음), Dashboard 설치 성공 로그, 그리고 port-forward 충돌(ssh가 127.0.0.1:8443 점유) 사례가 포함되어 있습니다.
